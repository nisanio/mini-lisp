# Chapter 2 — System Architecture

## 2.1 Module Map and Dependencies

Mini Lisp is structured into distinct C source and header files, each with a clear responsibility:

* **`main.c`** — Entry point; initializes the runtime, installs builtins, loads files, and starts the REPL.
* **`repl.c`** — Implements the Read–Eval–Print Loop (REPL).
* **`reader.c`** — Parses textual Lisp input into internal `Value*` structures.
* **`value.[ch]`** — Defines the core `Value` type and utilities for lists, symbols, strings, vectors, hashes.
* **`env.[ch]`** — Provides lexical environments and variable binding operations.
* **`eval.[ch]`** — Core evaluator; integrates macro expansion and dispatches on special forms.
* **`syntax.[ch]`** — Defines syntax objects (datum + scope set) for hygienic macros.
* **`macros.[ch]`** — Implements `syntax-rules` pattern matching, rule sets, and macro expansion.
* **`builtins.[ch]`** — Implements built-in procedures: arithmetic, list ops, I/O, macroexpand utilities.

### Dependency Graph (simplified)

```
 main → repl → (reader, eval)
 eval → (value, env, macros, syntax, builtins)
 macros → (syntax, value, env)
 builtins → (value, env, eval)
 reader → (value, symbols)
```

## 2.2 Process Lifecycle

1. **Startup**: `main.c` creates the global environment, installs constants and builtins.
2. **Load**: Optional library files (`stdlib.lisp`) are read.
3. **REPL**: For interactive mode, `repl.c` enters a loop: read → expand/eval → print.
4. **Exit**: Resources are freed (where applicable) and process terminates.

## 2.3 Memory Conventions

* **Allocation**: Values allocated on heap with constructors in `value.c`.
* **Ownership**: Environments hold references to values; lists/pairs manage recursive structures.
* **Strings**: Interned in a global table, duplicated with `xstrdup` (portable replacement for `strdup`).
* **Error handling**: On allocation failure, process aborts with `fprintf(stderr, "OOM")`.

## 2.4 Evaluation Pipeline

The interpreter enforces a consistent pipeline:

1. **Read**: `reader.c` parses S-expressions.
2. **Macro Expansion**: `eval.c` invokes `macroexpand1_hygienic` up to 128 times.
3. **Eval**: If form is a pair, check for special forms; otherwise apply.
4. **Apply**: Call closure or builtin with evaluated arguments.

---

Subsequent chapters will dive into the individual subsystems (`Value`, `Env`, `Eval`, `Macros`, etc.) with detailed structure and function-level documentation.
