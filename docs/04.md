# Chapter 4 — Environments (`env.[ch]`)

## 4.1 Overview

Environments in Mini Lisp implement **lexical scoping** by chaining frames. Each frame associates symbols with values and refers to a parent environment, forming a scope hierarchy.

## 4.2 Data Structures

* **`Env`**: structure holding

  * A hash table mapping `char*` symbol names → `Value*` objects.
  * A pointer to a parent `Env` (for lookups).

## 4.3 Core Operations

* **Creation**:

  * `make_env(parent)` — creates a new environment frame with optional parent.
  * `make_global()` — creates the top-level environment, installs constants (`#t`, `#f`, `nil`) and builtins.
* **Definition**:

  * `env_define(env, name, value)` — binds a new symbol in the current frame.
* **Lookup**:

  * `env_lookup(env, name)` — searches recursively through parent chain until found; returns `nil` or error if unbound.
* **Mutation**:

  * `env_set(env, name, value)` — updates an existing binding; traverses parent chain to find symbol.

## 4.4 Scoping Rules

* **Lexical closures**: When creating a closure, the current `Env*` is captured and stored in the closure’s value.
* **Shadowing**: If a symbol is redefined in a child environment, it shadows the parent binding.
* **Globals**: Accessible from anywhere unless shadowed.

## 4.5 Error Handling

* **Unbound symbols**: `env_lookup` returns error messages like `unbound symbol: <name>`.
* **Mutation failure**: `env_set` signals error if attempting to update an undefined variable.

## 4.6 Role in Evaluation

* The evaluator always receives an `Env*` argument.
* Symbol resolution and binding are central to evaluation of `define`, `set!`, and closure application.
* Environment objects are critical for hygiene in macros, since scope sets interact with environment frames.

---

Next chapter: **Evaluator (`eval.[ch]`)**, the core of execution and integration of macro expansion.
