# Chapter 15 — Extensibility Guide

## 15.1 Overview

Mini Lisp is intentionally designed to be **extensible**. New built-ins, types, and forms can be added by extending C modules and integrating with the evaluator.

## 15.2 Adding a Built-in

1. **Implement function** in `builtins.c`:

   ```c
   static Value* builtin_double(Value* args, Env* env) {
       Value* x = car(args);
       if (x->type != VAL_INT) return make_error("double: expected int");
       return make_int(x->as.i * 2);
   }
   ```
2. **Declare in header** (`builtins.h`).
3. **Register in global environment** (usually in `make_global()`):

   ```c
   env_define(global, "double", make_builtin(builtin_double));
   ```
4. **Test in REPL**:

   ```lisp
   > (double 21)
   42
   ```

## 15.3 Adding a New Type

1. **Extend `ValueTag` enum** in `value.h`.
2. **Add struct representation** in `value.c`.
3. **Write constructors, accessors, and printers**.
4. **Expose predicates** (e.g., `foo?`).
5. **Update evaluator** if special handling is required.

## 15.4 Adding a Special Form

1. **Modify `eval.c`** to recognize new keyword symbol.
2. **Implement semantics** directly in the evaluator.
3. Example: adding `while` loop:

   ```c
   else if (is_symbol_named(op, "while")) {
       Value* cond = car(args);
       Value* body = cdr(args);
       Value* result = nil;
       while (truthy(eval(cond, env))) {
           result = eval_sequence(body, env);
       }
       return result;
   }
   ```

## 15.5 Adding a Macro Form

* Preferred for higher-level syntactic sugar.
* Define in Lisp with `define-syntax` and `syntax-rules`.
* Example:

  ```lisp
  (define-syntax while
    (syntax-rules ()
      ((while test body ...)
       (let loop ()
         (if test
             (begin body ... (loop))
             nil)))))
  ```

## 15.6 Best Practices

* Keep C-level built-ins minimal; prefer Lisp macros.
* Test every addition with standalone scripts in `tests/`.
* Maintain error messages consistent with existing style.
* Ensure memory safety by using provided allocation helpers.

---

Next chapter: **Coding Standards and Conventions** — naming, style, and documentation practices.
